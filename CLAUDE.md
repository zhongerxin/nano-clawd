# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Run Commands

```bash
npm install          # Install dependencies
npm run build        # TypeScript compile (tsc) → dist/
npm run dev          # Dev mode via Bun (bun run src/index.ts)
npm run start        # Run compiled output (node dist/index.js)
npx tsc --noEmit     # Type-check without emitting
```

There are no tests or linting configured.

## Architecture

nano-clawd is a minimal terminal AI coding agent built on four `@mariozechner/pi-mono` packages. The entire app is 6 source files with a linear initialization flow in `index.ts`:

```
index.ts  →  auth.ts    (OAuth token)
          →  tools.ts   (8 AgentTools)
          →  mcp.ts     (dynamic MCP tools)
          →  prompt.ts  (system prompt + skills)
          →  tui.ts     (terminal UI + event rendering)
          →  Agent      (pi-agent-core)
```

**Main loop** (`index.ts`): `waitForInput()` → `agent.prompt(input)` → `agent.waitForIdle()` → repeat. Agent events drive TUI rendering via `agent.subscribe()`.

**Tool system** (`tools.ts`): Uses individual `create*Tool(cwd)` functions from pi-coding-agent (not `createAllTools` — that's not re-exported from the package's public API). Custom tools must implement `AgentTool<TSchema, TDetails>` from pi-agent-core with `execute(toolCallId, params, signal?, onUpdate?) → Promise<AgentToolResult<T>>`.

**MCP client** (`mcp.ts`): Custom JSON-RPC 2.0 over stdio implementation. Spawns child processes, manages newline-delimited message framing, and converts discovered MCP tools into `AgentTool` format with `mcp_{server}_{tool}` naming.

**TUI** (`tui.ts`): Uses ANSI color helpers (not the `theme` singleton, which isn't publicly exported from pi-coding-agent). Gets `MarkdownTheme` and `SelectListTheme` from pi-coding-agent's public API; constructs `EditorTheme` manually. Streaming updates use a `__isAssistantMd` marker on the last chat container child to find-or-create the Markdown component.

## Key pi-mono API Constraints

- **pi-coding-agent public exports**: `initTheme`, `getMarkdownTheme`, `getSelectListTheme`, `Theme` class are available. `theme` (singleton instance), `getEditorTheme()`, and `createAllTools()` are NOT re-exported from the main entry point.
- **AgentTool.execute** signature: `(toolCallId: string, params: Static<TParameters>, signal?: AbortSignal, onUpdate?: AgentToolUpdateCallback<TDetails>) => Promise<AgentToolResult<TDetails>>`
- **AgentToolResult** must have `{ content: (TextContent | ImageContent)[], details: T }`
- **Agent constructor** takes `{ initialState: { systemPrompt, model, thinkingLevel, tools }, getApiKey }`. The `getApiKey` callback receives provider string and returns `Promise<string | undefined>`.
- **OAuthCredentials** has `{ refresh, access, expires }` where `expires` is in **seconds** (not milliseconds).
- Tool parameter schemas use `@sinclair/typebox` (`Type.Object`, `Type.String`, etc.).
- Module system is ESM (`"type": "module"`); local imports require `.js` extension.

## User Config Paths

All stored under `~/.nano-clawd/`:
- `auth.json` — OAuth credentials (auto-generated by `--login`)
- `mcp.json` — MCP server configurations
- `skills/*.md` — Skill files with YAML frontmatter (`name`, `description`, `disable-model-invocation`)
